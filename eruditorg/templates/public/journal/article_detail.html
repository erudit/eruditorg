{% extends "public/base.html" %}
{% load i18n staticfiles %}
{% load public_journal_tags %}
{% load cache %}

{% block title %}{{ article.title }}{% endblock title %}

{% block meta_tags %}
{% cache FOREVER_TTL "public_article_detail_metatags" article.id LANGUAGE_CODE %}
<!-- Facebook / Open Graph -->
<meta property="fb:app_id" content="128099979787">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:type" content="article">
<meta property="og:title" content="{{ article.title }}">
<meta property="og:site_name" content="Érudit">
<meta property="og:locale" content="fr_CA">

<!-- Twitter -->
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@eruditorg">
<meta name="twitter:url" content="{{ request.build_absolute_uri }}">
<meta name="twitter:title" content="{{ article.title }} – Érudit">

{% if not article.issue.journal.type.code == 'C' %}
<!-- Google Scholar -->
  <meta name="citation_title" content="{{ article.title }}" />
  {% for author in article.authors.all %}
    {% if author.firstname and author.lastname %}
      <meta name="citation_author" content="{{ author.lastname }}, {{ author.firstname }}" />
    {% elif author.othername %}
      <meta name="citation_author" content="{{ author.othername }}" />
    {% endif %}
    {% for aff in author.affiliations.all %}
      <meta name="citation_author_institution" content="{{ aff.name }}" />
    {% endfor %}
  {% endfor %}
  <meta name="citation_journal_title" content="{{ article.issue.journal.name }}" />
  {% for abstract in article.abstracts.all %}
    <meta name="citation_abstract" lang="{{ abstract.language }}" content="{{ abstract.text }}" />
  {% endfor %}
  <meta name="citation_language" content="{{ article.language }}" />
  {% if article.first_page %}
    <meta name="citation_firstpage" content="{{ article.first_page }}" />
  {% endif %}
  {% if article.last_page %}
    <meta name="citation_lastpage" content="{{ article.last_page }}" />
  {% endif %}
  <meta name="citation_issn" content="{{ article.issue.journal.issn_print|default:article.issue.journal.issn_web }}" />
  {% if article.issue.volume %}
    <meta name="citation_volume" content="{{ article.issue.volume }}" />
  {% endif %}
  {% if article.issue.number %}
    <meta name="citation_issue" content="{{ article.issue.number }}" />
  {% endif %}
  <meta name="citation_publication_date" content="{{ article.issue.year }}" />
  <meta name="citation_date" content="{{ article.issue.year }}" />
  <meta name="citation_publisher" content="{{ article.publisher.name }}" />
  {% if article.doi %}<meta name="citation_doi" content="{{ article.doi }}" />{% endif %}
  <meta name="citation_html_url" content="{{ request.is_secure|yesno:"https,http" }}://{{ request.site.domain }}{% url 'public:journal:article_detail' journal_code=article.issue.journal.code issue_slug=article.issue.volume_slug issue_localid=article.issue.localidentifier localid=article.localidentifier %}" />
  <meta name="citation_pdf_url" content="{{ request.is_secure|yesno:"https,http" }}://{{ request.site.domain }}{% url 'public:journal:article_raw_pdf' journal_code=article.issue.journal.code issue_slug=article.issue.volume_slug issue_localid=article.issue.localidentifier localid=article.localidentifier %}" />
  {% for lang_code, keywords in keywords_dict.items %}
    <meta name="citation_keywords" lang="{{ lang_code }}" content="{% for k in keywords %}{{ k.name }}{% if not forloop.last %}, {% endif %}{% endfor %}" />
  {% endfor %}
{% endif %}
{% endcache %}
{% endblock meta_tags %}

{% block structured_data %}
{{ block.super }}
{% cache FOREVER_TTL "public_article_detail_structured_data" article.id LANGUAGE_CODE %}
{% include "public/journal/partials/article_structured_data.html" %}
{% endcache %}
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
    "@type": "ListItem",
    "position": 1,
    "item": {
      "@id": "{{ request.scheme }}://{{ request.site.domain }}",
      "name": "Érudit"
    }
  },{
    "@type": "ListItem",
    "position": 2,
    "item": {
      "@id": "{{ request.scheme }}://{{ request.site.domain }}{% url 'public:journal:journal_list' %}",
      "name": "{% trans 'Revues' %}"
    }
  },{
    "@type": "ListItem",
    "position": 3,
    "item": {
      "@id": "{{ request.scheme }}://{{ request.site.domain }}{% url 'public:journal:journal_detail' article.issue.journal.code %}",
      "name": "{{ article.issue.journal.name }}"
    }
  },{
    "@type": "ListItem",
    "position": 4,
    "item": {
      "@id": "{{ request.scheme }}://{{ request.site.domain }}{% url 'public:journal:issue_detail' article.issue.journal.code article.issue.volume_slug article.issue.localidentifier %}",
      "name": "{{ article.issue.volume_title_with_pages }}"
    }
  },{
    "@type": "ListItem",
    "position": 5,
    "item": {
      "@id": "{{ request.scheme }}://{{ request.site.domain }}{% url 'public:journal:article_detail' article.issue.journal.code article.issue.volume_slug article.issue.localidentifier article.localidentifier %}",
      "name": "{{ article.title }}"
    }
  }]
}
</script>
{% endblock structured_data %}

{% block body_class %}public static-header{% endblock body_class %}
{% block body_id %}article_detail{% endblock body_id %}
{% block data_controller %}public:journal:article_detail{% endblock data_controller %}

{% block header_class %}static{% endblock header_class %}

{% block breadcrumb %}{{ block.super }}
<li>
  <a href="{% url 'public:journal:journal_detail' article.issue.journal.code %}">{{ article.issue.journal.name }}</a>
</li>
<li>
  <a href="{% url 'public:journal:issue_detail' article.issue.journal.code article.issue.volume_slug article.issue.localidentifier %}">
   {% if article.issue.html_title %}
   {{ article.issue.html_title|striptags|safe|truncatechars:50 }}
   {% else %}
   {{ article.issue.volume_title_with_pages }}
   {% endif %}
  </a>
</li>
<li>
  <a href="{% url 'public:journal:article_detail' article.issue.journal.code article.issue.volume_slug article.issue.localidentifier article.localidentifier %}">{{ article.title|truncatechars:50 }}</a>
</li>
{% endblock breadcrumb %}

{% block alert %}
<div class="alert alert-warning">
  <div class="container">
    <p>
      {% blocktrans %}
      <span class="ion-alert-circled"></span> <strong>Attention</strong>&nbsp;: le site que vous visitez est actuellement en version bêta. L’affichage des articles (HTML, PDF) sera amélioré au cours des prochaines semaines. <br/><strong>Veuillez ne pas citer cet article</strong>, car l’adresse URL de cette page est temporaire. Pour citer un article, veuillez vous référer à <a href="{{ fallback_url }}" target="_blank">www.erudit.org</a>.
      {% endblocktrans %}
    </p>
  </div>
</div>
{% endblock alert %}

{% block content %}
<main
    class="container"
    data-document-id="{{ article.id }}"
    {% if article.id in request.saved_citations %}data-is-in-citation-list="true"{% else %}data-is-in-citation-list="false"{% endif %}
    role="main"
  >
  {% if not only_summary %}
  {% if previous_article %}
  <a href="{% url 'public:journal:article_detail' journal_code=previous_article.issue.journal.code issue_slug=previous_article.issue.volume_slug issue_localid=previous_article.issue.localidentifier localid=previous_article.localidentifier %}" class="pagination-arrow previous-page">
    <span class="hint--bottom-right hint--no-animate" data-hint="{{ previous_article.title }}">
      <span class="ion ion-ios-arrow-left"></span>
    </span>
  </a>
  {% endif %}
  {% if next_article %}
  <a href="{% url 'public:journal:article_detail' journal_code=next_article.issue.journal.code issue_slug=next_article.issue.volume_slug issue_localid=next_article.issue.localidentifier localid=next_article.localidentifier %}" class="pagination-arrow next-page">
    <span class="hint--bottom-left hint--no-animate" data-hint="{{ next_article.title }}">
      <span class="ion ion-ios-arrow-right"></span>
    </span>
  </a>
  {% endif %}
  {% else %}
  {% if previous_article %}
  <a href="{% url 'public:journal:article_summary' journal_code=previous_article.issue.journal.code issue_slug=previous_article.issue.volume_slug issue_localid=previous_article.issue.localidentifier localid=previous_article.localidentifier %}" class="pagination-arrow previous-page">
    <span class="hint--bottom-right hint--no-animate" data-hint="{{ previous_article.title }}">
      <span class="ion ion-ios-arrow-left"></span>
    </span>
  </a>
  {% endif %}
  {% if next_article %}
  <a href="{% url 'public:journal:article_summary' journal_code=next_article.issue.journal.code issue_slug=next_article.issue.volume_slug issue_localid=next_article.issue.localidentifier localid=next_article.localidentifier %}" class="pagination-arrow next-page">
    <span class="hint--bottom-left hint--no-animate" data-hint="{{ next_article.title }}">
      <span class="ion ion-ios-arrow-right"></span>
    </span>
  </a>
  {% endif %}
  {% endif %}

  {% cache FOREVER_TTL "public_article_detail_content" article.id article_access_granted in_citation_list LANGUAGE_CODE %}
  {% if article.publication_allowed_by_authors %}
    {# XSL transformation article render #}
    {% render_article article %}
  {% else %}
    <div class="alert alert-warning">
      {% trans "La diffusion de cet article sur Érudit n'a pas été autorisée par l'auteur." %}
    </div>
  {% endif %}
  {% endcache %}

  {# article footer with related articles #}
  {% if related_articles %}
  <footer class="related-articles">

    <div class="row">
      <header class="col-xs-12">
        <h2>{% trans "Autres articles de ce numéro" %}</h2>
      </header>
    </div>

    <div class="row">
      {% for related_article in related_articles %}
      {% cache FOREVER_TTL "public_article_detail_related_article" related_article.id LANGUAGE_CODE %}
      <article class="related-article col-sm-6 col-md-3">
        <a href="{% url 'public:journal:article_detail' journal_code=related_article.issue.journal.code issue_slug=article.issue.volume_slug issue_localid=related_article.issue.localidentifier localid=related_article.localidentifier %}">
          <h4>{{ related_article.title }}</h4>
          {% if related_article.authors.all|length > 0 %}
          <footer class="meta">
            <h5>{% trans 'Par' %} {{ related_article.authors.all|join:", " }}</h5>
          </footer>
          {% endif %}
        </a>
      </article>
      {% endcache %}
      {% endfor %}
    </div>

  </footer>
  {% endif %}

</main>

{% cache FOREVER_TTL "public_article_detail_citation" article.id LANGUAGE_CODE %}
<div class="hidden">
  {% include "public/journal/partials/article_citation_modal_content.html" %}
</div>
{% endcache %}

{% endblock content %}
