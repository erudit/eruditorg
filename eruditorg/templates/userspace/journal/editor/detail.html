{% extends "userspace/journal/base.html" %}
{% load i18n staticfiles %}
{% load rules %}

{% block title %}{{ issue }} – {% trans "Dépôt de fichiers" %}{% endblock title %}

{% block breadcrumb %}{{ block.super }}
<li><a href="{% url 'userspace:journal:editor:issues' %}">{% trans "Dépôt de fichiers" %}</a></li>
<li><a href="#">{{ issue }}</a></li>
{% endblock breadcrumb %}

{% block section_title %}
{{ issue }}
{% endblock %}

{% block content_main %}
{% has_perm 'editor.manage_issuesubmission' request.user scope_current_journal as can_manage_issuesubmission %}

<div class="row">
  <div class="col-md-8">
    <h2>{% trans "Informations du numéro" %}</h2>
  </div>
  {% if issue.is_draft %}
  <div class="col-md-4 text-right">
    <a href="{% url 'userspace:journal:editor:update' scope_current_journal.pk issue.pk %}" class="btn btn-secondary">{% trans "Modifier" %}</a>
  </div>
  {% endif %}
</div>

{# Issue submission metadata #}
<dl class="row submission-detail-metadata">
  <dt class="col-sm-3">{% trans "Statut" %}</dt>
  <dd class="col-sm-9">
    <span class="status-indicator-{% if issue.status == 'D' or issue.status == 'C' %}error{% elif issue.status == 'S' %}warning{% elif issue.status == 'V' %}success{% endif %}"></span>
    {% if issue.status == 'D' %}
      {% trans "Numéro" %} {{ issue.get_status_display|lower }}
    {% elif issue.status == 'C' %}
      {% trans "À corriger" %}
    {% else %}
      {{ issue.get_status_display }}
    {% endif %}
  </dd>
  <dt class="col-sm-3">{% trans "Année" %}</dt>
  <dd class="col-sm-9">{{ issue.year }}</dd>
  {% if issue.volume %}
  <dt class="col-sm-3">{% trans "Volume" %}</dt>
  <dd class="col-sm-9">{{ issue.volume }}</dd>
  {% endif %}
  <dt class="col-sm-3">{% trans "Numéro" %}</dt>
  <dd class="col-sm-9">{{ issue.number }}</dd>
  <dt class="col-sm-3">{% trans "Personne-ressource" %}</dt>
  <dd class="col-sm-9">{{ issue.contact }}</dd>
  <dt class="col-sm-3">{% trans "Commentaires" %}</dt>
  <dd class="col-sm-9">{% if issue.comment %}{{ issue.comment }}{% else %}{% trans '[Non renseigné]' %}{% endif %}</dd>
</dl>

<hr>

{# Uploaded files list #}
<h2>{% trans "Fichiers" %}</h2>
{% if track.status == 'D' %}
  <ul>
  {% if issue.last_files_version.submissions.exists %}
    {% for f in issue.last_files_version.submissions.all %}
      <li>
        {% if f.is_complete %}
        <a href="{% url 'userspace:journal:editor:attachment_detail' pk=f.id %}">{{ f.get_filename }}</a>{% if not forloop.last %}, {% endif %}
        {% else %}
        {{ f.get_filename }} ({% trans "partiellement téléversé" %}){% if not forloop.last %}, {% endif %}
        {% endif %}
      </li>
    {% endfor %}
  </ul>
  {% endif %}
{% else %}
<p>{% trans "[Aucun fichier soumis]" %}</p>
{% endif %}

<hr>

{# Issue submission history #}
{% if status_tracks %}
<h2>{% trans "Historique" %}</h2>
<div class="submissions">
  <ul class="submissions-header">
    <li class="row">
      <span class="col-sm-2">{% trans "Date" %}</span>
      <span class="col-sm-5">{% trans "Statut" %}</span>
      <span class="col-sm-5">{% trans "Commentaires" %}</span>
    </li>
  </ul>
  <ul class="submissions-list">
    {% for track in status_tracks reversed %}
    <li class="row submissions-item">
      <div class="clearfix submissions-content">
        <div class="col-sm-2">
          {% blocktrans trimmed with date=track.created|date:"SHORT_DATE_FORMAT" time=track.created|date:"H:i" %}
          {{ date }}<br> {{ time }}
          {% endblocktrans %}
        </div>
        <div class="col-sm-5">
          <p>
            {% if track.status == "D" %}
              {% trans "Corrections demandées" as status_prefix %}
            {% elif track.status == "S" %}
              {% trans "Soumis" as status_prefix %}
            {% elif track.status == "V" %}
              {% trans "Validé" as status_prefix %}
            {% endif %}
            {% with prefix=status_prefix %}
            {{ prefix }}
            {% endwith %}
          </p>

          {% if track.files_version and track.files_version.submissions.exists %}
          <p>
            {% trans "Fichiers&nbsp;:" %}
            {% for f in track.files_version.submissions.all %}
              {% if f.is_complete %}
                <a href="{% url 'userspace:journal:editor:attachment_detail' pk=f.id %}">{{ f.get_filename }}</a>{% if not forloop.last %}, {% endif %}
              {% else %}
                {{ f.get_filename }} ({% trans "partiellement téléversé" %}){% if not forloop.last %}, {% endif %}
              {% endif %}
            {% endfor %}
          </p>
          {% endif %}
        </div>

        <div class="col-sm-5">
          {% if track.comment %}
          <p>{{ track.comment }}</p>
          {% endif %}
        </div>
      </div>
    </li>
    {% endfor %}
  </ul>
</div>
{% endif %}

{# Submit / delete buttons #}
<div class="form-group text-right">
  {% if can_manage_issuesubmission and issue.is_draft %}
  <a href="{% url 'userspace:journal:editor:delete' scope_current_journal.pk issue.pk %}" class="btn">{% trans "Supprimer" %}</a>
  {% endif %}
  {% for t in transitions %}
  <a
  {% if t.name == 'submit' %}
  href="{% url 'userspace:journal:editor:transition_submit' scope_current_journal.pk issue.pk %}"
  {% elif t.name == 'approve' %}
  href="{% url 'userspace:journal:editor:transition_approve' scope_current_journal.pk issue.pk %}"
  {% elif t.name == 'refuse' %}
  href="{% url 'userspace:journal:editor:transition_refuse' scope_current_journal.pk issue.pk %}"
  {% endif %}
  class="btn btn-primary">{{ t.custom.verbose_name }}</a>
  {% endfor %}
</div>
{% endblock content_main %}
